<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Containers, Security, and Echo Chambers</title>
        <link rel="stylesheet" href="../static/css/main.css"/>
    </head>
    <body>
        <header>
            <nav>
                <div>
                    <a id="site" href="https://sigtor.org">
                        <span>sig</span>
                        <span style="font-style: italic;">tor</span>
                    </a>
                </div>
                <div id="external">
                    <a href="https://github.com/rhurkes">
                        <svg class="icon" preserveAspectRatio="xMidYMid" version="1.1" viewBox="0 0 256 250" xmlns="http://www.w3.org/2000/svg"><path d="m128 0c-70.684 0-128 57.307-128 128 0 56.554 36.676 104.53 87.535 121.46 6.3971 1.1849 8.7457-2.7767 8.7457-6.1576 0-3.0523-0.1187-13.135-0.17381-23.831-35.61 7.7431-43.124-15.102-43.124-15.102-5.8227-14.795-14.212-18.729-14.212-18.729-11.614-7.9444 0.87541-7.7812 0.87541-7.7812 12.854 0.90297 19.622 13.191 19.622 13.191 11.416 19.569 29.944 13.911 37.249 10.641 1.1488-8.273 4.4661-13.92 8.1267-17.116-28.431-3.2367-58.318-14.212-58.318-63.259 0-13.975 5.0002-25.393 13.188-34.357-1.329-3.224-5.7103-16.243 1.24-33.874 0 0 10.749-3.4402 35.209 13.121 10.21-2.8361 21.16-4.2584 32.038-4.3071 10.878 0.048752 21.837 1.471 32.066 4.3071 24.431-16.561 35.165-13.121 35.165-13.121 6.9673 17.631 2.5838 30.65 1.2548 33.874 8.2073 8.964 13.174 20.382 13.174 34.357 0 49.163-29.944 59.988-58.447 63.157 4.5911 3.9722 8.6821 11.762 8.6821 23.704 0 17.127-0.14837 30.911-0.14837 35.127 0 3.4063 2.3041 7.3976 8.7923 6.1406 50.831-16.944 87.461-64.908 87.461-121.44 0-70.694-57.309-128-128-128zm-80.061 182.34c-0.28191 0.63589-1.2824 0.82666-2.1938 0.39002-0.9284-0.41757-1.4498-1.2845-1.1488-1.9225 0.27555-0.65497 1.2781-0.83726 2.2044-0.39849 0.93052 0.41757 1.4604 1.293 1.1382 1.931zm6.2962 5.618c-0.61046 0.56594-1.8038 0.30311-2.6135-0.59138-0.83726-0.89237-0.99411-2.0857-0.37518-2.6602 0.62953-0.56594 1.7869-0.30099 2.6262 0.59138 0.83726 0.90297 1.0005 2.0878 0.36246 2.6602zm4.3195 7.1881c-0.78427 0.54475-2.0667 0.033914-2.8594-1.1043-0.78427-1.1382-0.78427-2.5033 0.016957-3.0502 0.79487-0.54687 2.0582-0.05511 2.8615 1.0747 0.78215 1.1573 0.78215 2.5224-0.019077 3.0798zm7.3051 8.3248c-0.7016 0.77367-2.196 0.56595-3.2897-0.48964-1.1192-1.0323-1.4308-2.4969-0.72704-3.2706 0.71008-0.77579 2.2129-0.55747 3.3151 0.48964 1.1107 1.0301 1.4498 2.5054 0.7016 3.2706zm9.4412 2.8104c-0.30947 1.0026-1.7487 1.4583-3.1985 1.0323-1.4477-0.43877-2.3952-1.613-2.1027-2.6262 0.30099-1.009 1.7466-1.4838 3.207-1.028 1.4456 0.43665 2.3952 1.6025 2.0942 2.622zm10.744 1.1921c0.036034 1.0556-1.1934 1.931-2.7153 1.9501-1.5304 0.033914-2.7683-0.8203-2.7852-1.8589 0-1.0662 1.2018-1.9331 2.7322-1.9586 1.5219-0.029675 2.7683 0.81818 2.7683 1.8674zm10.555-0.4046c0.18229 1.0301-0.87541 2.0878-2.3867 2.3698-1.4859 0.27131-2.8615-0.36458-3.0502-1.3862-0.18441-1.0556 0.89237-2.1133 2.3761-2.3867 1.5134-0.26284 2.8679 0.3561 3.0608 1.4032z" /></svg>
                    </a>
                    <a href="https://twitter.com/rhurkes">
                        <svg class="icon" preserveAspectRatio="xMidYMid" version="1.1" viewBox="0 0 256 209" xmlns="http://www.w3.org/2000/svg"><path d="m256 25.45c-9.4192 4.1772-19.542 7.0005-30.166 8.2702 10.844-6.5004 19.172-16.793 23.093-29.057-10.148 6.0182-21.388 10.389-33.351 12.745-9.5812-10.208-23.231-16.586-38.337-16.586-29.007 0-52.523 23.516-52.523 52.52 0 4.1164 0.46539 8.1251 1.3606 11.969-43.651-2.1902-82.351-23.1-108.26-54.875-4.5209 7.7571-7.111 16.779-7.111 26.404 0 18.221 9.2731 34.297 23.366 43.715-8.6101-0.27249-16.708-2.635-23.79-6.5688-0.0037455 0.21912-0.0037455 0.43917-0.0037455 0.66016 0 25.447 18.104 46.675 42.131 51.5-4.4076 1.2005-9.0474 1.8419-13.838 1.8419-3.3841 0-6.6746-0.32867-9.8808-0.94201 6.683 20.867 26.079 36.051 49.062 36.475-17.975 14.086-40.622 22.483-65.228 22.483-4.239 0-8.42-0.24814-12.529-0.7332 23.243 14.902 50.851 23.596 80.511 23.596 96.606 0 149.43-80.031 149.43-149.43 0-2.2773-0.050565-4.5424-0.1517-6.7945 10.261-7.405 19.166-16.656 26.208-27.188" /></svg>
                    </a>
                </div>
            </nav>
        </header>
        <article>
            <section id="title">
                <h1>Containers, Security, and Echo Chambers</h1>
                <div id="date">February 20, 2020</div>
                <div id="tags"><a href="/tags/containers">containers</a>, <a href="/tags/kubernetes">kubernetes</a>, <a href="/tags/docker">docker</a>, <a href="/tags/gvisor">gvisor</a></div>
            </section>
            <section><p>There seems to be some confusion around sandboxing containers as of late,
mostly because of the recent launch of <a href="https://github.com/google/gvisor">gvisor</a>.
Before I get into the body of this post I would like to make one thing clear.
I have no problem with gvisor itself. I think it is very technically &quot;cool.&quot;
I do have a problem with the messaging around it and marketing.</p>
<p>There is a large amount of ignorance towards the existing defaults to make
containers secure. Which is crazy since I have written many blog posts on it
and given many talks on the subject. But I digress, let's focus on the part of the README that
mentions sandboxing with SELinux, Seccomp, and Apparmor. It says: &quot;However, in practice 
it can be extremely difficult (if not impossible) to reliably define a policy 
for arbitrary, previously unknown applications, making this approach challenging 
to apply universally.&quot;</p>
<p>Greetings. Reporting for duty. Literally I am the person who can do that. I was
the person who <em>did</em> do that. I added the default Seccomp profile to Docker and
maintained the default Apparmor profile. I have also done A LOT of research
with regard to Linux kernel isolation and making containers secure.
I also literally reported for duty, two years ago and made the patch to add the
Seccomp annotation to Kubernetes... with the hopes of eventually turning on
a default filter.</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/nathanmccauley?ref_src=twsrc%5Etfw">@nathanmccauley</a> <a href="https://twitter.com/brendandburns?ref_src=twsrc%5Etfw">@brendandburns</a> <a href="https://twitter.com/kelseyhightower?ref_src=twsrc%5Etfw">@kelseyhightower</a> <a href="https://twitter.com/thockin?ref_src=twsrc%5Etfw">@thockin</a> I already offered to help</p>&mdash; jessie frazelle (@jessfraz) <a href="https://twitter.com/jessfraz/status/717215121840451584?ref_src=twsrc%5Etfw">April 5, 2016</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>All big organizations have problems with &quot;not invented here.&quot; I tried my very
best to inform everyone how these sandboxing mechanisms work but I am going to
try one last time here.</p>
<h2>More than One Layer of Security Required</h2>
<p>In my last blog post, 
<a href="https://blog.jessfraz.com/post/hard-multi-tenancy-in-kubernetes/">Hard Multi-Tenancy in Kubernetes</a>, 
I mentioned this as well. It is also a good read if you want to learn about the 
thought process for secure isolation. To be truly secure you need more than one
layer of security so that when there is a vulnerability in one layer, the attacker also
needs a vulnerability in another layer to bypass the isolation mechanism.</p>
<p>In Docker, we worked really hard to create secure defaults for the container
isolation itself. I then tried to bring all those up the stack into
orchestrators.</p>
<p>Container runtimes have security layers defined by Seccomp, Apparmor, kernel 
namespaces, cgroups, capabilities, and an unprivileged Linux user. All the 
layers don’t perfectly overlap, but a few do.</p>
<p>Let's go over some of the ones that do overlap. I could do them all, but
I would be here all day. The <code>mount</code> syscall is prevented by the default
Apparmor profile, default Seccomp profile, and <code>CAP_SYS_ADMIN</code>. This is a neat
example as it is literally three layers. Wow.</p>
<p>Everyone's favorite thing to complain about in containers or to prove that they
know something is creating a fork bomb. Well this is actually easily
preventable. With the PID cgroup you can set a max number of processes per
container.</p>
<p>What about things that are not namespaced by the linux kernel..? <code>CAP_SYS_TIME</code>
prevents people from changing the time inside containers. And the default
Seccomp profile prevents modifications or interacting with the kernel keyring.</p>
<p>If you would like a list of all the syscalls prevented by the default Seccomp
profile, I behoove you to read the list <a href="https://github.com/jessfraz/community/blob/1eaf775381bbd6d3c6e32816144beba1bca807b4/contributors/design-proposals/seccomp.md#default-profile">here</a>. It also has descriptions of each.</p>
<p>Two years ago, there was <a href="https://www.nccgroup.trust/us/our-research/understanding-and-hardening-linux-containers/">a great Whitepaper from NCC Group about hardening
linux containers</a>. Still to this day I get all the good feels when I see all the mentions of my work in it. But if you have any hesitations towards the defaults in Docker or otherwise I suggest you educate yourself first.</p>
<p>I will call out my favorite chart here though. Below shows the defaults from
various container runtimes as of two years ago.  Note the strong defaults in
Docker. The paper also explains at length the defaults and would be a less
biased version than me explaining myself.</p>
<p><img src="defaults.png" alt="defaults.png" /></p>
<p>The <a href="https://github.com/jessfraz/docker/blob/6837cfc13cba842186a7261aa9bbd3a8755fd11e/docs/security/non-events.md">non-events</a> are also an interesting read.</p>
<h2>Breaking Changes</h2>
<p>A lot of the push back I got from the default Seccomp profile was related to it
being a breaking change. </p>
<p>I get that this is very scary. No really I get it. When we added it to Docker,
guess who got paged when the Docker apt repo was down and it was on the front
page of hacker news with tech bros crying: me. So I was absolutely horrified at
the thought of making a breaking change that might land on the front page of
hacker news as well.</p>
<p><span class="sidenote"><a href="http://www.edwardtufte.com/tufte/books_be"><em>Beautiful Evidence</em></a></span></p>
<p>The last thing I ever wanted to do was cause a breaking change. That shit was
terrifying. I lost sleep over weeks worrying about it. I tested every single
Dockerfile on GitHub with the default profile. I ran <code>strace</code> on each for
EPERMS and sent them all to elastic search. I made a project just for it:
<a href="https://github.com/jessfraz/strace2elastic">strace2elastic</a>. It's super dumb
but was fun.</p>
<blockquote cite="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB">
<p>[It is] notable that the Feynman lectures (3 volumes) write about all of physics in 1800 pages, using only 2 levels of hierarchical headings: chapters and A-level heads in the text. It also uses the methodology of <em>sentences</em> which then cumulate sequentially into <em>paragraphs</em>, rather than the grunts of bullet points. Undergraduate Caltech physics is very complicated material, but it didn’t require an elaborate hierarchy to organize.</p>
<footer><a href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB">Edward Tufte, forum post, ‘Book design: advice and examples’ thread</a></footer>
</blockquote>
<p>By the time we released I knew I had done at least everything in my power to
make sure we didn't break anyone. The release actually went really well too.
However, when you try to explain this to other projects they of course have
their doubts, which I do not blame them for. I wish there was a better way
to trust the genuine people who just want to help in open source.</p>
<h2>So why all the confusion and FUD?</h2>
<p>Well, it's simple really. Marketing. The tech never sells itself. It's all
about marketing. </p>
<p>When you work at a large organization you are surrounded by an echo chamber. So
if everyone in the org is saying &quot;containers are not secure,&quot; you are bound to
believe it and not research actual facts. To be clear I am not saying containers
are secure, literally nothing is secure. Spreading FUD while ignorant or not
doing proper research is harmful to the facts and hard work many people put in
to making containers at least decently isolated by default.</p>
<h2>Operability</h2>
<p>There is another problem I have with gvisor. In my opinion, I think it would be
quite hard to operate. People enjoy debugging with certain workflows and
reinventing syscalls is going to be quite hard to debug. Just look up one of
Bryan Cantrill's rants on unikernels which are harder to debug as well.</p>
<p>I believe it is putting a lot of extra burden on the operator to learn how to
operate. At the end of the day you are left with a decision to trust or
research the container security defaults or use a new runtime that
re-implements all the syscalls in user-space and has poorer performance because of
that. I also have yet to see a report on the fact that running in user-space is
actually more secure. The implementation could be closely related to that of
user mode linux and even user mode linux was never fully vetted for
multi-tenancy so what are you really gaining. I truly believe it cannot be
possibly more secure than the defaults for containers are today and surely it
is not as secure as a real hypervisor. But, again, nothing is actually secure.</p>
<p>I am not trying to throw shade at gvisor but merely clear up some FUD in the
world of open source marketing. I truly believe that people choosing projects
to use should research into them and not just choose something shiny that came
out of Big Corp. I also believe that people at Big Corp should embrace the work
and ideas of people outside their echo chamber. Sometimes they even work in the
echo chamber but just don't abide by the echo chamber beliefs.</p>
<p>Open your minds and hearts to the ideas of other people and you might just
create something you never thought was possible in the first place.</p>
<p><strong>Update:</strong> See <a href="https://blog.hansenpartnership.com/measuring-the-horizontal-attack-profile-of-nabla-containers/">James Bottomley's research on Horizontal Attack Profile</a> which shows gVisor uses more syscalls than a standard docker container.</p>
</section>
        </article>
        <footer>
            <span id="copyright">© Rob Hurkes</span>
        </footer>
    </body>
</html>
